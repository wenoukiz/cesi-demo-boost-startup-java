on:
  workflow_call:
    secrets:
      NVD_API_KEY:
        required: false
        description: 'NVD API Key for faster dependency database download (optional)'
permissions:
  security-events: write
  contents: read

jobs:
  sca-dependency-scan:
    name: SCA - OWASP Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'liberica'
          cache: 'maven'

      - name: ğŸ” Check NVD API Key availability
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          if [ -n "${NVD_API_KEY}" ]; then
            echo "âœ… NVD API Key is configured (length: ${#NVD_API_KEY} chars)"
            echo "ğŸ”‘ First 8 chars: ${NVD_API_KEY:0:8}..."
          else
            echo "âš ï¸ NVD API Key not configured - download will be slower"
            echo "ğŸ’¡ Configure it in: Settings â†’ Secrets â†’ Actions â†’ NVD_API_KEY"
            echo "ğŸ’¡ Get your key at: https://nvd.nist.gov/developers/request-an-api-key"
          fi

      - name: ğŸ“¦ Run OWASP Dependency Check
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          if [ -n "${NVD_API_KEY}" ]; then
            echo "ğŸš€ Running with NVD API Key for faster download"
            mvn org.owasp:dependency-check-maven:check \
              -DfailBuildOnCVSS=7 \
              -DsuppressionFiles=.owasp-suppressions.xml \
              -DnvdApiKey=${NVD_API_KEY}
          else
            echo "ğŸŒ Running without NVD API Key (slower download)"
            mvn org.owasp:dependency-check-maven:check \
              -DfailBuildOnCVSS=7 \
              -DsuppressionFiles=.owasp-suppressions.xml
          fi

      - name: ğŸ“¤ Upload Dependency Check SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('target/dependency-check-report.sarif') != ''
        with:
          sarif_file: target/dependency-check-report.sarif
          category: owasp-dependency-check

      - name: ğŸ” Run Trivy SCA (filesystem scan)
        uses: aquasecurity/trivy-action@0.27.0
        with:
          scan-type: 'fs'
          format: 'json'
          output: 'trivy-deps-report.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          ignore-unfixed: true

      - name: ğŸ“¤ Upload Trivy SCA report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-deps-report
          path: trivy-deps-report.json
          retention-days: 7
